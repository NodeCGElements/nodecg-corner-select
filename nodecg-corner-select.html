<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<dom-module id="nodecg-corner-select">
    <style>
        #label {
        @apply(--paper-font-body2);
        }

        .option {
            width: 50%;
            margin: 0;
        }

        #metaSelector > :not(.iron-selected) {
            display: none;
        }

        .userSelector {
        @apply(--layout-horizontal);
            flex-wrap: wrap;
        }

        .userSelector .iron-selected {
            background: var(--paper-light-blue-400);
            transition: background 125ms linear;
        }
    </style>

    <template>
        <div id="label">{{label}}</div>
        <iron-selector id="metaSelector" attr-for-selected="type" selected="{{type}}">
            <iron-selector type="corner" selectable=".option" class="userSelector">
                <paper-button class="option" data-vert="top" data-horiz="left">
                    <iron-icon icon="arrow-back" style="transform: rotate(45deg);"></iron-icon>
                </paper-button>
                <paper-button class="option" data-vert="top" data-horiz="right">
                    <iron-icon icon="arrow-forward" style="transform: rotate(-45deg);"></iron-icon>
                </paper-button>

                <paper-button class="option" data-vert="bottom" data-horiz="left">
                    <iron-icon icon="arrow-back" style="transform: rotate(-45deg);"></iron-icon>
                </paper-button>
                <paper-button class="option" data-vert="bottom" data-horiz="right">
                    <iron-icon icon="arrow-forward" style="transform: rotate(45deg);"></iron-icon>
                </paper-button>
            </iron-selector>

            <iron-selector type="vertical" class="userSelector row">
                <paper-button class="option" data-vert="top">
                    <iron-icon icon="arrow-back" style="transform: rotate(90deg);"></iron-icon>
                </paper-button>
                <paper-button class="option" data-vert="bottom">
                    <iron-icon icon="arrow-forward" style="transform: rotate(-90deg);"></iron-icon>
                </paper-button>
            </iron-selector>

            <iron-selector type="horizontal" class="userSelector row">
                <paper-button class="option" data-horiz="left">
                    <iron-icon icon="arrow-back"></iron-icon>
                </paper-button>
                <paper-button class="option" data-horiz="right">
                    <iron-icon icon="arrow-forward"></iron-icon>
                </paper-button>
            </iron-selector>
        </iron-selector>
    </template>
</dom-module>

<script>
    Polymer({
        is: 'nodecg-corner-select',

        /*
         * Properties
         */

        properties: {
            label: {
                type: String
            },
            defaultHorizPos: {
                type: String,
                value: 'right'
            },
            defaultVertPos: {
                type: String,
                value: 'bottom'
            },
            replicantName: {
                type: String
            },
            replicantBundle: {
                type: String,
                value: window.nodecg.bundleName
            },
            type: {
                type: String,
                value: 'corner'
            }
        },

        observers: [
            '_updateReplicant(replicantName, replicantBundle)'
        ],

        _updateReplicant: function(name, bundle) {
            // If there is an existing replicant, remove the event listener
            if (this.replicant) {
                this.replicant.removeListener('change', this._replicantChanged);
            }

            this.replicant = NodeCG.Replicant(name, bundle, {
                defaultValue: {
                    horizPos: this.defaultHorizPos,
                    vertPos: this.defaultVertPos
                }
            });

            this.replicant.on('change', this._replicantChanged.bind(this));
        },

        /*
         * Lifecycle
         */

        ready: function() {
            var self = this;

            var cornerSelector = this.$$('iron-selector[type="corner"]');
            cornerSelector.addEventListener('iron-select', function(e) {
                var item = e.detail.item;
                self.replicant.value.horizPos = item.getAttribute('data-horiz');
                self.replicant.value.vertPos = item.getAttribute('data-vert');
            });

            var verticalSelector = this.$$('iron-selector[type="vertical"]');
            verticalSelector.addEventListener('iron-select', function(e) {
                var item = e.detail.item;
                self.replicant.value.vertPos = item.getAttribute('data-vert');
            });

            var horizontalSelector = this.$$('iron-selector[type="horizontal"]');
            horizontalSelector.addEventListener('iron-select', function(e) {
                var item = e.detail.item;
                self.replicant.value.horizPos = item.getAttribute('data-horiz');
            });

            // If `nodecg` is defined and `replicantBundle` is not, default it to `nodecg.bundleName`
            if (window.nodecg && !this.replicantBundle) {
                this.replicantBundle = window.nodecg.bundleName;
            }
        },

        /*
         * Events
         */

        _replicantChanged: function(oldVal, newVal) {
            var cornerSelector = this.$$('iron-selector[type="corner"]');
            cornerSelector.items.forEach(function(item, index) {
                var vert = item.getAttribute('data-vert');
                var horiz = item.getAttribute('data-horiz');
                if (vert === newVal.vertPos && horiz === newVal.horizPos) {
                    cornerSelector.select(index);
                }
            });

            var verticalSelector = this.$$('iron-selector[type="vertical"]');
            verticalSelector.items.forEach(function(item, index) {
                var vert = item.getAttribute('data-vert');
                if (vert === newVal.vertPos) {
                    verticalSelector.select(index);
                }
            });

            var horizontalSelector = this.$$('iron-selector[type="horizontal"]');
            horizontalSelector.items.forEach(function(item, index) {
                var horiz = item.getAttribute('data-horiz');
                if (horiz === newVal.horizPos) {
                    horizontalSelector.select(index);
                }
            });
        }
    });
</script>
